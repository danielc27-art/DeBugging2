{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
    <button class="info-button" onclick="openModal()" title="How this page should work">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M10 6v8M10 4v0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
    </button>
    
    <div class="chat-container">
        <h1>Chat</h1>
        <div id="chat-messages"></div>
        <div class="chat-input-group">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
{% endblock %}

{% block modal_content %}
    <h3>How This Page Should Work:</h3>
    <ul>
        <li><strong>Chat Messages Container (div#chat-messages):</strong> Displays all chat messages. Starts empty.</li>
        <li><strong>User Input (input#user-input):</strong> Text field where the user types their message.</li>
        <li><strong>Send Button:</strong> When clicked, should:
            <ul>
                <li>Get the text from the input field</li>
                <li>Add the user message to the chat display</li>
                <li>Send the message to the <code>/chat-stream</code> endpoint</li>
                <li>Handle the streaming response and display assistant messages as they arrive</li>
                <li>Clear the input field</li>
            </ul>
        </li>
        <li><strong>sendMessage():</strong> This function should:
            <ul>
                <li>Add user message to the conversation array</li>
                <li>Call <code>addMessage()</code> to display the user's message</li>
                <li>Make a POST request to <code>/chat-stream</code> with the conversation history</li>
                <li>Process the streaming response and update the assistant message in real-time</li>
            </ul>
        </li>
        <li><strong>addMessage(role, text):</strong> Creates and displays a message bubble with the specified role (user or assistant) and text.</li>
        <li><strong>Streaming Response:</strong> The response comes in chunks prefixed with "data: ". Each chunk should be appended to the assistant's message.</li>
    </ul>
{% endblock %}

{% block scripts %}
    <script>
        var conversation = [];
        
        function sendMessage() {
            var input = document.getElementById('user-input');
            var message = input.value.trim();
            if (message === '') return;
            
            addMessage('user', message);
            input.value = '';
            
            conversation.push({role: 'user', content: message});
            
            fetch('/chat-stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({conversation: conversation})
            })
            .then(function(response) {
                var reader = response.body.getReader();
                var decoder = new TextDecoder();
                var assistantMessage = '';
                var messageDiv = addMessage('assistant', '');
                
                function readChunk() {
                    reader.read().then(function(result) {
                        if (result.done) {
                            conversation.push({role: 'assistant', content: assistantMessage});
                            return;
                        }
                        
                        var chunk = decoder.decode(result.value);
                        var lines = chunk.split('\n');
                        
                        for (var i = 0; i < lines.length; i++) {
                            if (lines[i].startsWith('data: ')) {
                                var data = lines[i].substring(6);
                                if (data === '[DONE]') {
                                    return;
                                }
                                assistantMessage += data;
                                messageDiv.textContent = assistantMessage;
                            }
                        }
                        
                        readChunk();
                    });
                }
                
                readChunk();
            });
        }
        
        function addMessage(role, text) {
            var container = document.getElementById('chat-messages');
            var div = document.createElement('div');
            div.className = 'chat-message chat-' + role;
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }
        
        document.getElementById('user-input').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
{% endblock %}

